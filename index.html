<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TelecomEst Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: Arial, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* TOP NAV */
  #topbar {
    background: #16213e;
    border-bottom: 2px solid #00d4ff;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  #topbar h1 {
    font-size: 1.4rem;
    color: #00d4ff;
    letter-spacing: 2px;
  }

  #topbar span {
    font-size: 0.75rem;
    color: #888;
    letter-spacing: 1px;
  }

  /* TAKEOFF SUMMARY BAR - NOW HORIZONTAL AT TOP */
  #takeoff-bar {
    background: #16213e;
    border-bottom: 1px solid #2a2a4a;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-shrink: 0;
    overflow-x: auto;
    max-height: 60px;
  }

  #takeoff-bar-label {
    font-size: 0.7rem;
    letter-spacing: 2px;
    color: #888;
    text-transform: uppercase;
    white-space: nowrap;
  }

  #takeoff-items {
    display: flex;
    gap: 15px;
    flex-wrap: nowrap;
    overflow-x: auto;
  }

  .takeoff-chip {
    background: #0f3460;
    border: 1px solid #2a4a7a;
    border-radius: 20px;
    padding: 6px 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .takeoff-chip-name {
    font-size: 0.8rem;
    color: #00d4ff;
  }

  .takeoff-chip-count {
    font-size: 0.85rem;
    color: #00ff88;
    font-weight: bold;
  }

  .takeoff-chip-pages {
    font-size: 0.65rem;
    color: #888;
  }

  .empty-takeoff {
    font-size: 0.75rem;
    color: #555;
    font-style: italic;
  }

  /* MAIN LAYOUT */
  #main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* LEFT SIDEBAR */
  #sidebar {
    width: 140px;
    background: #16213e;
    border-right: 1px solid #2a2a4a;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow-y: auto;
    transition: margin-left 0.3s ease, width 0.3s ease;
  }

  #sidebar.hidden {
    margin-left: -140px;
    width: 0;
    overflow: hidden;
  }

  #sidebar h3 {
    padding: 12px 10px;
    font-size: 0.65rem;
    letter-spacing: 2px;
    color: #888;
    text-transform: uppercase;
    border-bottom: 1px solid #2a2a4a;
  }

  #page-thumbnails {
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .thumb {
    background: #0f3460;
    border: 2px solid #2a2a4a;
    border-radius: 4px;
    padding: 6px;
    cursor: pointer;
    text-align: center;
    font-size: 0.7rem;
    color: #aaa;
    transition: all 0.2s;
  }

  .thumb:hover, .thumb.active {
    border-color: #00d4ff;
    color: #00d4ff;
    background: #0a2040;
  }

  .thumb canvas {
    width: 100%;
    border-radius: 2px;
    display: block;
    margin-bottom: 4px;
  }

  /* CENTER VIEWER */
  #viewer-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: #0d0d1a;
  }

  /* TOOLBAR */
  #toolbar {
    background: #16213e;
    border-bottom: 1px solid #2a2a4a;
    padding: 8px 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    flex-shrink: 0;
  }

  .toolbar-group {
    display: flex;
    align-items: center;
    gap: 6px;
    padding-right: 12px;
    border-right: 1px solid #2a2a4a;
  }

  .toolbar-group:last-child { border-right: none; }

  .toolbar-group label {
    font-size: 0.7rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1px;
    white-space: nowrap;
  }

  button {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #2a4a7a;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s;
    white-space: nowrap;
  }

  button:hover { background: #1a4a8a; border-color: #00d4ff; color: #00d4ff; }
  button.active { background: #00d4ff; color: #000; border-color: #00d4ff; font-weight: bold; }
  button.green { background: #0a4a2a; border-color: #00ff88; color: #00ff88; }
  button.green:hover { background: #00ff88; color: #000; }

  input[type="number"], input[type="text"], select {
    background: #0d1a2e;
    border: 1px solid #2a4a7a;
    color: #e0e0e0;
    padding: 5px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    width: 80px;
  }

  select { width: auto; }

  /* SCALE STATUS */
  #scale-status {
    font-size: 0.72rem;
    padding: 3px 8px;
    border-radius: 3px;
    background: #1a1a2e;
    border: 1px solid #2a2a4a;
  }

  #scale-status.calibrated {
    border-color: #00ff88;
    color: #00ff88;
  }

  #scale-status.uncalibrated {
    border-color: #ffaa00;
    color: #ffaa00;
  }

  /* PDF CANVAS AREA */
  #canvas-container {
    flex: 1;
    overflow: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 20px;
    position: relative;
  }

  #canvas-wrapper {
    position: relative;
    display: inline-block;
    cursor: crosshair;
  }

  #pdf-canvas {
    display: block;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }

  #overlay-canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
  }

  /* UPLOAD SCREEN */
  #upload-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
  }

  #upload-screen.hidden { display: none; }
  #viewer-wrap { display: none; flex: 1; flex-direction: column; overflow: hidden; }
  #viewer-wrap.visible { display: flex; }

  #drop-zone {
    border: 2px dashed #00d4ff;
    border-radius: 12px;
    padding: 60px 80px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #16213e;
  }

  #drop-zone:hover, #drop-zone.dragover {
    background: #0a2040;
    border-color: #00ff88;
  }

  #drop-zone .icon { font-size: 3rem; margin-bottom: 12px; }
  #drop-zone h2 { font-size: 1.2rem; color: #00d4ff; margin-bottom: 8px; }
  #drop-zone p { font-size: 0.85rem; color: #888; }

  #file-input { display: none; }

  /* CALIBRATION MODAL */
  #cal-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  #cal-modal.show { display: flex; }

  #cal-box {
    background: #16213e;
    border: 1px solid #00d4ff;
    border-radius: 8px;
    padding: 30px;
    width: 380px;
    text-align: center;
  }

  #cal-box h3 { color: #00d4ff; margin-bottom: 8px; font-size: 1.1rem; }
  #cal-box p { font-size: 0.82rem; color: #aaa; margin-bottom: 20px; line-height: 1.5; }

  .cal-row {
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    margin-bottom: 15px;
  }

  .cal-row label { font-size: 0.8rem; color: #ccc; white-space: nowrap; }
  .cal-row input { width: 100px; }
  .cal-row select { width: 70px; }

  #cal-result {
    font-size: 0.8rem;
    color: #00ff88;
    min-height: 20px;
    margin-bottom: 15px;
  }

  .modal-btns { display: flex; gap: 10px; justify-content: center; }

  /* PAGE INFO BAR */
  #page-info {
    background: #16213e;
    border-top: 1px solid #2a2a4a;
    padding: 6px 15px;
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 0.75rem;
    color: #888;
    flex-shrink: 0;
  }

  #page-info span { color: #ccc; }
  #page-info .sep { color: #2a2a4a; }

  /* INSTRUCTIONS */
  .instruction-bar {
    display: none;
    position: fixed;
    top: 135px;
    left: 50%;
    transform: translateX(-50%);
    background: #ffaa00;
    color: #000;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: bold;
    z-index: 50;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
  }

  /* ZOOM */
  #zoom-display {
    font-size: 0.75rem;
    color: #00d4ff;
    min-width: 40px;
    text-align: center;
  }

  /* TAKEOFF MODAL */
  #takeoff-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  #takeoff-modal.show { display: flex; }

  /* LINEAR MODAL */
  #linear-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  #linear-modal.show { display: flex; }

  /* AVERAGE CONFIG MODAL */
  #avg-config-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  #avg-config-modal.show { display: flex; }

  #takeoff-modal-box {
    background: #16213e;
    border: 1px solid #00d4ff;
    border-radius: 8px;
    padding: 25px;
    width: 400px;
  }

  #takeoff-modal-box h3 {
    color: #00d4ff;
    margin-bottom: 6px;
    font-size: 1.1rem;
  }

  #takeoff-modal-box p {
    font-size: 0.8rem;
    color: #aaa;
    margin-bottom: 18px;
  }

  #takeoff-modal-box label {
    display: block;
    font-size: 0.75rem;
    color: #ccc;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  #takeoff-modal-box select {
    width: 100%;
    margin-bottom: 20px;
    padding: 8px;
  }

  /* MARKER STYLES */
  .marker {
    position: absolute;
    width: 24px;
    height: 24px;
    background: #00ff88;
    border: 2px solid #000;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    color: #000;
    cursor: pointer;
    pointer-events: auto;
    box-shadow: 0 2px 8px rgba(0,255,136,0.5);
  }

  .marker:hover {
    background: #00d4ff;
    box-shadow: 0 2px 12px rgba(0,212,255,0.7);
  }

  /* AVERAGE RUNS TRACKER */
  #avg-runs-panel {
    display: none;
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: #16213e;
    border: 2px solid #00d4ff;
    border-radius: 8px;
    padding: 15px 20px;
    min-width: 280px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    z-index: 50;
  }

  #avg-runs-panel h4 {
    color: #00d4ff;
    font-size: 0.9rem;
    margin-bottom: 10px;
    letter-spacing: 1px;
  }

  #avg-runs-list {
    margin-bottom: 12px;
    max-height: 150px;
    overflow-y: auto;
  }

  .avg-run-item {
    font-size: 0.8rem;
    color: #ccc;
    padding: 4px 0;
    border-bottom: 1px solid #2a2a4a;
  }

  .avg-run-item:last-child {
    border-bottom: none;
  }

  #avg-summary {
    font-size: 0.85rem;
    color: #00ff88;
    margin-bottom: 12px;
    padding: 8px;
    background: #0a2040;
    border-radius: 4px;
  }

  .avg-btns {
    display: flex;
    gap: 8px;
  }

  .avg-btns button {
    flex: 1;
    font-size: 0.75rem;
    padding: 8px 10px;
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <h1>‚ö° TELECOMEST PRO</h1>
  <span id="version-display">PHASE 1 ‚Äî PDF VIEWER & QUANTITY TAKEOFF ‚Äî <span style="color:#00ff88"></span></span>
</div>

<!-- TAKEOFF SUMMARY BAR -->
<div id="takeoff-bar">
  <div id="takeoff-bar-label">TAKEOFF SUMMARY:</div>
  <div id="takeoff-items">
    <div class="empty-takeoff">No takeoffs yet ‚Äî click "Count Items" to start</div>
  </div>
</div>

<div id="main">

  <!-- LEFT SIDEBAR -->
  <div id="sidebar">
    <h3>Pages</h3>
    <div id="page-thumbnails"></div>
  </div>

  <!-- VIEWER AREA -->
  <div id="viewer-area">

    <!-- UPLOAD SCREEN -->
    <div id="upload-screen">
      <div id="drop-zone" onclick="document.getElementById('file-input').click()">
        <div class="icon">üìÑ</div>
        <h2>Upload Construction Drawing</h2>
        <p>Click or drag & drop a PDF file<br>Supports multi-page drawing sets</p>
      </div>
      <input type="file" id="file-input" accept=".pdf">
      <p style="font-size:0.75rem; color:#555;">Your drawings stay on your device ‚Äî nothing is uploaded to any server</p>
    </div>

    <!-- VIEWER WRAP (hidden until PDF loaded) -->
    <div id="viewer-wrap">

      <!-- TOOLBAR -->
      <div id="toolbar">

        <div class="toolbar-group">
          <label>Page</label>
          <button onclick="changePage(-1)">‚óÄ</button>
          <span id="page-num" style="font-size:0.8rem; min-width:60px; text-align:center;">1 / 1</span>
          <button onclick="changePage(1)">‚ñ∂</button>
        </div>

        <div class="toolbar-group">
          <label>Zoom</label>
          <button onclick="changeZoom(-0.25)">‚àí</button>
          <span id="zoom-display">100%</span>
          <button onclick="changeZoom(0.25)">+</button>
          <button onclick="fitToWindow()">Fit</button>
        </div>

        <div class="toolbar-group">
          <label>Scale</label>
          <button id="cal-btn" onclick="startCalibration()">üìê Calibrate</button>
          <div id="scale-status" class="uncalibrated">‚ö† Not Calibrated</div>
        </div>

        <div class="toolbar-group">
          <label>Takeoff</label>
          <button id="takeoff-btn" onclick="startTakeoff()">üìç Count Items</button>
          <button id="linear-btn" onclick="startLinear('straight')">üìè Linear</button>
          <button id="avg-btn" onclick="startLinear('average')">üìê Avg + Drops</button>
        </div>

        <div class="toolbar-group">
          <button onclick="document.getElementById('file-input').click()" style="font-size:0.75rem;">üìÇ New PDF</button>
          <button onclick="toggleSidebar()" style="font-size:0.75rem;" title="Hide/show page thumbnails">‚¨å Pages</button>
        </div>

      </div>

      <!-- INSTRUCTION BARS -->
      <div id="cal-instructions" class="instruction-bar">
        üìê CALIBRATION MODE: Click two points on the drawing that represent a known distance
      </div>

      <div id="takeoff-instructions" class="instruction-bar">
        üìç TAKEOFF MODE: Click on items to count them (jacks, outlets, devices, etc.)
      </div>

      <div id="linear-instructions" class="instruction-bar">
        üìè LINEAR MODE: Click points to trace. Hold SHIFT for horizontal/vertical/45¬∞ snap. Double-click or Enter to finish.
      </div>

      <div id="average-instructions" class="instruction-bar">
        üìê AVERAGE MODE: Trace sample runs (hold SHIFT to snap). After each: click "Add Another Run" or "Finish & Calculate"
      </div>

      <!-- PDF CANVAS -->
      <div id="canvas-container">
        <div id="canvas-wrapper">
          <canvas id="pdf-canvas"></canvas>
          <canvas id="overlay-canvas"></canvas>
          <div id="markers-container"></div>
        </div>
      </div>

      <!-- PAGE INFO BAR -->
      <div id="page-info">
        <span>Page: <span id="info-page">‚Äî</span></span>
        <span class="sep">|</span>
        <span>Scale: <span id="info-scale">Not calibrated</span></span>
        <span class="sep">|</span>
        <span>File: <span id="info-file">‚Äî</span></span>
      </div>

    </div><!-- /viewer-wrap -->

  </div><!-- /viewer-area -->

</div><!-- /main -->

<!-- CALIBRATION MODAL -->
<div id="cal-modal">
  <div id="cal-box">
    <h3>üìê Set Drawing Scale</h3>
    <p>After clicking two points on the drawing,<br>enter the real-world distance between them.</p>
    <div class="cal-row">
      <label>Distance:</label>
      <input type="number" id="cal-distance" placeholder="e.g. 10" min="0.01" step="0.01">
      <select id="cal-unit">
        <option value="ft">ft</option>
        <option value="in">in</option>
        <option value="m">m</option>
      </select>
    </div>
    <div id="cal-result"></div>
    <div class="modal-btns">
      <button class="green" onclick="confirmCalibration()">‚úì Set Scale</button>
      <button onclick="cancelCalibration()">Cancel</button>
    </div>
  </div>
</div>

<!-- TAKEOFF ITEM SELECTION MODAL -->
<div id="takeoff-modal">
  <div id="takeoff-modal-box">
    <h3>üìç What are you counting?</h3>
    <p>Select the catalog item for this takeoff point</p>
    <label>Item Type</label>
    <select id="takeoff-item-select">
      <optgroup label="Copper - Horizontal">
        <option value="cat6a-jack">Cat6A Jack / Outlet</option>
        <option value="cat6-jack">Cat6 Jack / Outlet</option>
        <option value="cat5e-jack">Cat5e Jack / Outlet</option>
      </optgroup>
      <optgroup label="Fiber - Connectors">
        <option value="fiber-sc">Fiber SC Connector</option>
        <option value="fiber-lc">Fiber LC Duplex Connector</option>
        <option value="fiber-mpo">Fiber MPO/MTP Connector</option>
      </optgroup>
      <optgroup label="Equipment & Hardware">
        <option value="faceplate-2port">2-Port Faceplate</option>
        <option value="faceplate-4port">4-Port Faceplate</option>
        <option value="patch-panel-24">24-Port Patch Panel</option>
        <option value="patch-panel-48">48-Port Patch Panel</option>
        <option value="rack-1u">1U Rack Mount Device</option>
      </optgroup>
      <optgroup label="Devices">
        <option value="ap-wireless">Wireless Access Point</option>
        <option value="camera-ip">IP Camera</option>
        <option value="phone-voip">VoIP Phone Outlet</option>
      </optgroup>
    </select>
    <div class="modal-btns" style="margin-top:20px;">
      <button class="green" onclick="confirmTakeoffItem()">‚úì Add Point</button>
      <button onclick="cancelTakeoffItem()">Cancel</button>
    </div>
  </div>
</div>

<!-- LINEAR ITEM SELECTION MODAL -->
<div id="linear-modal">
  <div id="takeoff-modal-box">
    <h3>üìè What are you tracing?</h3>
    <p>Select the cable or pathway type before tracing</p>
    <label>Cable / Pathway Type</label>
    <select id="linear-item-select">
      <optgroup label="Copper Cable">
        <option value="cable-cat6a">Cat6A Cable</option>
        <option value="cable-cat6">Cat6 Cable</option>
      </optgroup>
      <optgroup label="Fiber Cable">
        <option value="cable-fiber-om3">Fiber Cable OM3 (Multimode)</option>
        <option value="cable-fiber-om4">Fiber Cable OM4 (Multimode)</option>
        <option value="cable-fiber-os2">Fiber Cable OS2 (Singlemode)</option>
      </optgroup>
      <optgroup label="Conduit & Pathway">
        <option value="conduit-emt-3-4">3/4" EMT Conduit</option>
        <option value="conduit-emt-1">1" EMT Conduit</option>
        <option value="cable-tray-4">4" Cable Tray</option>
        <option value="cable-tray-6">6" Cable Tray</option>
        <option value="pathway-jhook">J-Hook Pathway</option>
      </optgroup>
    </select>
    <div class="modal-btns" style="margin-top:20px;">
      <button class="green" onclick="confirmLinearItem()">‚úì Start Tracing</button>
      <button onclick="cancelLinearItem()">Cancel</button>
    </div>
  </div>
</div>

<!-- AVERAGE RUNS TRACKER PANEL -->
<div id="avg-runs-panel">
  <h4>üìê SAMPLE RUNS</h4>
  <div id="avg-runs-list"></div>
  <div id="avg-summary"></div>
  <div class="avg-btns">
    <button onclick="addAnotherRun()">+ Another Run</button>
    <button class="green" onclick="finishAverage()">‚úì Finish & Calculate</button>
  </div>
</div>

<!-- AVERAGE DROP CONFIGURATION MODAL -->
<div id="avg-config-modal">
  <div id="takeoff-modal-box">
    <h3>üìê Configure Drops</h3>
    <p>Set the total number of drops and drop length</p>
    
    <label>Total Number of Drops</label>
    <input type="number" id="avg-drop-count" placeholder="e.g. 50" min="1" step="1" style="width:100%; margin-bottom:15px;">
    
    <label>Drop Length (ft)</label>
    <input type="number" id="avg-drop-length" placeholder="e.g. 12" min="0" step="0.5" style="width:100%; margin-bottom:20px;">
    
    <div id="avg-calc-preview" style="font-size:0.85rem; color:#00ff88; margin-bottom:15px; padding:10px; background:#0a2040; border-radius:4px;"></div>
    
    <div class="modal-btns">
      <button class="green" onclick="confirmAverageConfig()">‚úì Save Takeoff</button>
      <button onclick="cancelAverageConfig()">Cancel</button>
    </div>
  </div>
</div>

<script>
// PDF.js setup
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// VERSION - Update this after each change
const APP_VERSION = 'v1.2';

// Update version display on page load
document.addEventListener('DOMContentLoaded', function() {
  const versionSpan = document.querySelector('#version-display span');
  if (versionSpan) versionSpan.textContent = APP_VERSION;
});

// Catalog item names
const CATALOG_NAMES = {
  'cat6a-jack': 'Cat6A Jack',
  'cat6-jack': 'Cat6 Jack',
  'cat5e-jack': 'Cat5e Jack',
  'fiber-sc': 'Fiber SC Connector',
  'fiber-lc': 'Fiber LC Connector',
  'fiber-mpo': 'Fiber MPO Connector',
  'faceplate-2port': '2-Port Faceplate',
  'faceplate-4port': '4-Port Faceplate',
  'patch-panel-24': '24-Port Patch Panel',
  'patch-panel-48': '48-Port Patch Panel',
  'rack-1u': '1U Rack Device',
  'ap-wireless': 'Wireless AP',
  'camera-ip': 'IP Camera',
  'phone-voip': 'VoIP Outlet',
  // Linear items
  'cable-cat6a': 'Cat6A Cable',
  'cable-cat6': 'Cat6 Cable',
  'cable-fiber-om3': 'Fiber Cable OM3',
  'cable-fiber-om4': 'Fiber Cable OM4',
  'cable-fiber-os2': 'Fiber Cable OS2',
  'conduit-emt-3-4': '3/4" EMT Conduit',
  'conduit-emt-1': '1" EMT Conduit',
  'cable-tray-4': '4" Cable Tray',
  'cable-tray-6': '6" Cable Tray',
  'pathway-jhook': 'J-Hook Pathway'
};

// STATE
let pdfDoc = null;
let currentPage = 1;
let totalPages = 0;
let zoomLevel = 1.0;
let fileName = '';

// Scale calibration state per page
let pageScales = {};
let calMode = false;
let calPoints = [];
let calPixelDistance = 0;

// Takeoff state
let takeoffMode = false;
let pendingTakeoffPoint = null;
let takeoffs = {}; // { pageNum: [{ x, y, itemId, markerNum }] }
let markerCounter = 0;

// Linear takeoff state
let linearMode = false;
let linearModeType = null; // 'straight' or 'average'
let linearPoints = [];
let linearItemId = null;
let linears = {}; // { pageNum: [{ points: [{x,y}], itemId, lengthFt, type }] }
let averageRuns = []; // For average mode: array of {lengthFt} for each traced run
let avgDropCount = 0;
let avgDropLength = 0;
let mousePos = { x: 0, y: 0 }; // Track mouse position for live preview
let shiftPressed = false; // Track shift key for axis snapping

// ‚îÄ‚îÄ‚îÄ PDF LOADING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

document.getElementById('file-input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  fileName = file.name;
  const reader = new FileReader();
  reader.onload = function(ev) {
    loadPDF(ev.target.result);
  };
  reader.readAsArrayBuffer(file);
});

// Drag and drop
const dropZone = document.getElementById('drop-zone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file && file.type === 'application/pdf') {
    fileName = file.name;
    const reader = new FileReader();
    reader.onload = ev => loadPDF(ev.target.result);
    reader.readAsArrayBuffer(file);
  }
});

async function loadPDF(arrayBuffer) {
  const data = new Uint8Array(arrayBuffer);
  pdfDoc = await pdfjsLib.getDocument({ data }).promise;
  totalPages = pdfDoc.numPages;
  currentPage = 1;

  document.getElementById('upload-screen').classList.add('hidden');
  document.getElementById('viewer-wrap').classList.add('visible');

  await buildThumbnails();
  await renderPage(currentPage);
  updateInfo();
}

async function buildThumbnails() {
  const container = document.getElementById('page-thumbnails');
  container.innerHTML = '';
  for (let i = 1; i <= totalPages; i++) {
    const page = await pdfDoc.getPage(i);
    const vp = page.getViewport({ scale: 0.15 });
    const thumbCanvas = document.createElement('canvas');
    thumbCanvas.width = vp.width;
    thumbCanvas.height = vp.height;
    const ctx = thumbCanvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport: vp }).promise;

    const thumb = document.createElement('div');
    thumb.className = 'thumb' + (i === 1 ? ' active' : '');
    thumb.id = 'thumb-' + i;
    thumb.appendChild(thumbCanvas);
    thumb.appendChild(document.createTextNode('Pg ' + i));
    thumb.onclick = () => goToPage(i);
    container.appendChild(thumb);
  }
}

async function renderPage(pageNum) {
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: zoomLevel });

  const pdfCanvas = document.getElementById('pdf-canvas');
  const overlayCanvas = document.getElementById('overlay-canvas');
  const ctx = pdfCanvas.getContext('2d');

  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;
  overlayCanvas.width = viewport.width;
  overlayCanvas.height = viewport.height;

  await page.render({ canvasContext: ctx, viewport }).promise;

  document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
  const activeThumb = document.getElementById('thumb-' + pageNum);
  if (activeThumb) activeThumb.classList.add('active');

  document.getElementById('page-num').textContent = pageNum + ' / ' + totalPages;
  updateScaleStatus();
  renderMarkers();
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function changePage(dir) {
  const newPage = currentPage + dir;
  if (newPage < 1 || newPage > totalPages) return;
  currentPage = newPage;
  await renderPage(currentPage);
  updateInfo();
  updateTakeoffSummary();
}

async function goToPage(num) {
  currentPage = num;
  await renderPage(currentPage);
  updateInfo();
  updateTakeoffSummary();
}

// ‚îÄ‚îÄ‚îÄ ZOOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function changeZoom(delta) {
  zoomLevel = Math.max(0.25, Math.min(4.0, zoomLevel + delta));
  document.getElementById('zoom-display').textContent = Math.round(zoomLevel * 100) + '%';
  await renderPage(currentPage);
}

async function fitToWindow() {
  if (!pdfDoc) return;
  const page = await pdfDoc.getPage(currentPage);
  const vp = page.getViewport({ scale: 1 });
  const container = document.getElementById('canvas-container');
  const scaleX = (container.clientWidth - 40) / vp.width;
  const scaleY = (container.clientHeight - 40) / vp.height;
  zoomLevel = Math.min(scaleX, scaleY);
  document.getElementById('zoom-display').textContent = Math.round(zoomLevel * 100) + '%';
  await renderPage(currentPage);
}

// ‚îÄ‚îÄ‚îÄ CALIBRATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function startCalibration() {
  if (!pdfDoc) { alert('Please upload a PDF first.'); return; }
  if (takeoffMode) endTakeoff();
  calMode = true;
  calPoints = [];
  document.getElementById('cal-instructions').style.display = 'block';
  document.getElementById('canvas-wrapper').style.cursor = 'crosshair';
  document.getElementById('cal-btn').classList.add('active');
}

function cancelCalibration() {
  calMode = false;
  calPoints = [];
  document.getElementById('cal-modal').classList.remove('show');
  document.getElementById('cal-instructions').style.display = 'none';
  document.getElementById('canvas-wrapper').style.cursor = 'crosshair';
  document.getElementById('cal-btn').classList.remove('active');
  clearOverlay();
}

function drawCalPoint(x, y, num) {
  const ctx = document.getElementById('overlay-canvas').getContext('2d');
  ctx.fillStyle = '#ffaa00';
  ctx.beginPath();
  ctx.arc(x, y, 6, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#000';
  ctx.font = 'bold 10px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(num, x, y);
}

function drawCalLine() {
  const ctx = document.getElementById('overlay-canvas').getContext('2d');
  ctx.strokeStyle = '#ffaa00';
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 3]);
  ctx.beginPath();
  ctx.moveTo(calPoints[0].x, calPoints[0].y);
  ctx.lineTo(calPoints[1].x, calPoints[1].y);
  ctx.stroke();
  ctx.setLineDash([]);
}

function clearOverlay() {
  const canvas = document.getElementById('overlay-canvas');
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
}

function confirmCalibration() {
  const dist = parseFloat(document.getElementById('cal-distance').value);
  const unit = document.getElementById('cal-unit').value;
  if (!dist || dist <= 0) { alert('Please enter a valid distance.'); return; }

  let distInFeet = dist;
  if (unit === 'in') distInFeet = dist / 12;
  if (unit === 'm') distInFeet = dist * 3.28084;

  const pixelsPerFoot = calPixelDistance / distInFeet;

  pageScales[currentPage] = {
    pixelsPerFoot,
    zoomAtCalibration: zoomLevel,
    displayStr: dist + ' ' + unit
  };

  calMode = false;
  document.getElementById('cal-modal').classList.remove('show');
  document.getElementById('cal-btn').classList.remove('active');
  clearOverlay();
  updateScaleStatus();
  updateInfo();

  alert('‚úÖ Scale set! Page ' + currentPage + ' is now calibrated.');
}

function updateScaleStatus() {
  const statusEl = document.getElementById('scale-status');
  if (pageScales[currentPage]) {
    statusEl.className = 'calibrated';
    statusEl.textContent = '‚úì Calibrated';
  } else {
    statusEl.className = 'uncalibrated';
    statusEl.textContent = '‚ö† Not Calibrated';
  }
}

function updateInfo() {
  document.getElementById('info-page').textContent = currentPage + ' of ' + totalPages;
  document.getElementById('info-file').textContent = fileName || '‚Äî';
  if (pageScales[currentPage]) {
    const s = pageScales[currentPage];
    document.getElementById('info-scale').textContent = 'Set from ' + s.displayStr + ' reference';
  } else {
    document.getElementById('info-scale').textContent = 'Not calibrated';
  }
}

// ‚îÄ‚îÄ‚îÄ TAKEOFF MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function startTakeoff() {
  if (!pdfDoc) { alert('Please upload a PDF first.'); return; }
  if (calMode) cancelCalibration();
  takeoffMode = true;
  document.getElementById('takeoff-instructions').style.display = 'block';
  document.getElementById('canvas-wrapper').style.cursor = 'crosshair';
  document.getElementById('takeoff-btn').classList.add('active');
}

function endTakeoff() {
  takeoffMode = false;
  document.getElementById('takeoff-instructions').style.display = 'none';
  document.getElementById('takeoff-btn').classList.remove('active');
}

function cancelTakeoffItem() {
  pendingTakeoffPoint = null;
  document.getElementById('takeoff-modal').classList.remove('show');
  if (takeoffMode) {
    document.getElementById('takeoff-instructions').style.display = 'block';
  }
}

function confirmTakeoffItem() {
  const itemId = document.getElementById('takeoff-item-select').value;
  if (!itemId) { alert('Please select an item type.'); return; }

  if (!takeoffs[currentPage]) takeoffs[currentPage] = [];

  markerCounter++;
  takeoffs[currentPage].push({
    x: pendingTakeoffPoint.x,
    y: pendingTakeoffPoint.y,
    itemId,
    markerNum: markerCounter
  });

  document.getElementById('takeoff-modal').classList.remove('show');
  pendingTakeoffPoint = null;

  renderMarkers();
  updateTakeoffSummary();

  if (takeoffMode) {
    document.getElementById('takeoff-instructions').style.display = 'block';
  }
}

function renderMarkers() {
  const container = document.getElementById('markers-container');
  container.innerHTML = '';

  if (!takeoffs[currentPage]) return;

  takeoffs[currentPage].forEach(t => {
    const marker = document.createElement('div');
    marker.className = 'marker';
    marker.style.left = t.x + 'px';
    marker.style.top = t.y + 'px';
    marker.textContent = t.markerNum;
    marker.title = CATALOG_NAMES[t.itemId] || t.itemId;
    container.appendChild(marker);
  });
}

function updateTakeoffSummary() {
  const container = document.getElementById('takeoff-items');

  // Aggregate quantity counts across all pages
  const summary = {};
  for (let pageNum in takeoffs) {
    takeoffs[pageNum].forEach(t => {
      if (!summary[t.itemId]) {
        summary[t.itemId] = { count: 0, pages: new Set(), type: 'qty' };
      }
      summary[t.itemId].count++;
      summary[t.itemId].pages.add(parseInt(pageNum));
    });
  }

  // Aggregate linear totals across all pages
  for (let pageNum in linears) {
    linears[pageNum].forEach(l => {
      if (!summary[l.itemId]) {
        summary[l.itemId] = { totalFt: 0, pages: new Set(), type: 'linear' };
      }
      if (summary[l.itemId].type === 'linear') {
        summary[l.itemId].totalFt += l.lengthFt;
      }
      summary[l.itemId].pages.add(parseInt(pageNum));
    });
  }

  if (Object.keys(summary).length === 0) {
    container.innerHTML = '<div class="empty-takeoff">No takeoffs yet ‚Äî click "Count Items" or "Trace Linear" to start</div>';
    return;
  }

  let html = '';
  for (let itemId in summary) {
    const data = summary[itemId];
    const pages = Array.from(data.pages).sort((a,b) => a - b).join(', ');
    
    if (data.type === 'qty') {
      html += `
        <div class="takeoff-chip">
          <div class="takeoff-chip-name">${CATALOG_NAMES[itemId] || itemId}</div>
          <div class="takeoff-chip-count">${data.count}</div>
          <div class="takeoff-chip-pages">pg ${pages}</div>
        </div>
      `;
    } else {
      html += `
        <div class="takeoff-chip">
          <div class="takeoff-chip-name">${CATALOG_NAMES[itemId] || itemId}</div>
          <div class="takeoff-chip-count">${Math.round(data.totalFt)} ft</div>
          <div class="takeoff-chip-pages">pg ${pages}</div>
        </div>
      `;
    }
  }

  container.innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ CANVAS CLICK HANDLER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

document.getElementById('canvas-wrapper').addEventListener('click', function(e) {
  const rect = document.getElementById('pdf-canvas').getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  // CALIBRATION MODE
  if (calMode) {
    calPoints.push({ x, y });
    drawCalPoint(x, y, calPoints.length);

    if (calPoints.length === 2) {
      const dx = calPoints[1].x - calPoints[0].x;
      const dy = calPoints[1].y - calPoints[0].y;
      calPixelDistance = Math.sqrt(dx * dx + dy * dy);
      drawCalLine();
      document.getElementById('cal-instructions').style.display = 'none';
      document.getElementById('cal-modal').classList.add('show');
      document.getElementById('cal-result').textContent =
        'Pixel distance: ' + Math.round(calPixelDistance) + 'px between your two points';
    }
    return;
  }

  // TAKEOFF MODE
  if (takeoffMode) {
    pendingTakeoffPoint = { x, y };
    document.getElementById('takeoff-instructions').style.display = 'none';
    document.getElementById('takeoff-modal').classList.add('show');
    return;
  }

  // LINEAR MODE
  if (linearMode && linearItemId) {
    linearPoints.push({ x, y });
    drawLinearPath();
    return;
  }
});

// Handle double-click to finish linear trace
document.getElementById('canvas-wrapper').addEventListener('dblclick', function(e) {
  if (linearMode && linearItemId && linearPoints.length >= 2) {
    finishLinear();
  }
});

// Handle mousemove for live line preview
document.getElementById('canvas-wrapper').addEventListener('mousemove', function(e) {
  if (!linearMode || !linearItemId) return;
  
  const rect = document.getElementById('pdf-canvas').getBoundingClientRect();
  let x = e.clientX - rect.left;
  let y = e.clientY - rect.top;
  
  // If we have at least one point and shift is pressed, snap to axis
  if (linearPoints.length > 0 && shiftPressed) {
    const lastPoint = linearPoints[linearPoints.length - 1];
    const dx = Math.abs(x - lastPoint.x);
    const dy = Math.abs(y - lastPoint.y);
    
    // Determine if horizontal, vertical, or 45-degree
    if (dx > dy * 2) {
      // Snap to horizontal
      y = lastPoint.y;
    } else if (dy > dx * 2) {
      // Snap to vertical
      x = lastPoint.x;
    } else {
      // Snap to 45-degree
      const dist = Math.min(dx, dy);
      x = lastPoint.x + (x > lastPoint.x ? dist : -dist);
      y = lastPoint.y + (y > lastPoint.y ? dist : -dist);
    }
  }
  
  mousePos = { x, y };
  drawLinearPath();
});

// Track shift key state
document.addEventListener('keydown', function(e) {
  if (e.key === 'Shift') {
    shiftPressed = true;
    if (linearMode && linearPoints.length > 0) {
      drawLinearPath(); // Redraw with snapping
    }
  }
});

document.addEventListener('keyup', function(e) {
  if (e.key === 'Shift') {
    shiftPressed = false;
    if (linearMode && linearPoints.length > 0) {
      drawLinearPath(); // Redraw without snapping
    }
  }
});

// Handle Enter key to finish linear trace
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && linearMode && linearItemId && linearPoints.length >= 2) {
    finishLinear();
  }
});

// ‚îÄ‚îÄ‚îÄ LINEAR TAKEOFF FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function startLinear(mode) {
  if (!pdfDoc) { alert('Please upload a PDF first.'); return; }
  if (calMode) cancelCalibration();
  if (takeoffMode) endTakeoff();
  
  linearModeType = mode;
  
  // Show modal to select item first
  document.getElementById('linear-modal').classList.add('show');
}

function cancelLinearItem() {
  document.getElementById('linear-modal').classList.remove('show');
  linearModeType = null;
}

function confirmLinearItem() {
  const itemId = document.getElementById('linear-item-select').value;
  if (!itemId) { alert('Please select a cable/pathway type.'); return; }

  linearMode = true;
  linearItemId = itemId;
  linearPoints = [];
  
  if (linearModeType === 'average') {
    averageRuns = [];
    document.getElementById('avg-runs-panel').style.display = 'block';
    updateAvgRunsDisplay();
    document.getElementById('average-instructions').style.display = 'block';
    document.getElementById('avg-btn').classList.add('active');
  } else {
    document.getElementById('linear-instructions').style.display = 'block';
    document.getElementById('linear-btn').classList.add('active');
  }
  
  document.getElementById('linear-modal').classList.remove('show');
}

function endLinear() {
  linearMode = false;
  linearModeType = null;
  linearItemId = null;
  linearPoints = [];
  averageRuns = [];
  document.getElementById('linear-instructions').style.display = 'none';
  document.getElementById('average-instructions').style.display = 'none';
  document.getElementById('avg-runs-panel').style.display = 'none';
  document.getElementById('linear-btn').classList.remove('active');
  document.getElementById('avg-btn').classList.remove('active');
  clearOverlay();
}

function drawLinearPath() {
  const ctx = document.getElementById('overlay-canvas').getContext('2d');
  clearOverlay();

  if (linearPoints.length === 0) return;

  // Draw all confirmed points
  linearPoints.forEach((p, idx) => {
    ctx.fillStyle = '#00d4ff';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#000';
    ctx.font = 'bold 9px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(idx + 1, p.x, p.y);
  });

  // Draw confirmed lines between points
  if (linearPoints.length > 1) {
    ctx.strokeStyle = '#00d4ff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(linearPoints[0].x, linearPoints[0].y);
    for (let i = 1; i < linearPoints.length; i++) {
      ctx.lineTo(linearPoints[i].x, linearPoints[i].y);
    }
    ctx.stroke();
  }

  // Draw live preview line from last point to mouse
  if (linearPoints.length > 0 && mousePos.x && mousePos.y) {
    const lastPoint = linearPoints[linearPoints.length - 1];
    
    ctx.strokeStyle = 'rgba(0, 212, 255, 0.4)'; // Semi-transparent
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]); // Dashed line
    ctx.beginPath();
    ctx.moveTo(lastPoint.x, lastPoint.y);
    ctx.lineTo(mousePos.x, mousePos.y);
    ctx.stroke();
    ctx.setLineDash([]); // Reset dash
    
    // Draw preview point at mouse position
    ctx.fillStyle = 'rgba(0, 212, 255, 0.3)';
    ctx.beginPath();
    ctx.arc(mousePos.x, mousePos.y, 4, 0, Math.PI * 2);
    ctx.fill();
    
    // If shift is pressed, show a visual indicator
    if (shiftPressed) {
      ctx.strokeStyle = '#ffaa00';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(mousePos.x, mousePos.y, 8, 0, Math.PI * 2);
      ctx.stroke();
    }
  }
}

function calculatePathLength() {
  if (!pageScales[currentPage]) {
    return null;
  }

  let totalPixels = 0;
  for (let i = 1; i < linearPoints.length; i++) {
    const dx = linearPoints[i].x - linearPoints[i - 1].x;
    const dy = linearPoints[i].y - linearPoints[i - 1].y;
    totalPixels += Math.sqrt(dx * dx + dy * dy);
  }

  const scale = pageScales[currentPage];
  return totalPixels / scale.pixelsPerFoot;
}

function finishLinear() {
  if (!pageScales[currentPage]) {
    alert('‚ö†Ô∏è Page not calibrated! Please calibrate the scale first.');
    endLinear();
    return;
  }

  const lengthFt = calculatePathLength();
  if (!lengthFt) return;

  if (linearModeType === 'straight') {
    // Save straight linear takeoff
    if (!linears[currentPage]) linears[currentPage] = [];
    linears[currentPage].push({
      points: [...linearPoints],
      itemId: linearItemId,
      lengthFt: lengthFt,
      type: 'straight'
    });

    alert(`‚úÖ Linear takeoff saved!\n\n${CATALOG_NAMES[linearItemId]}\nLength: ${Math.round(lengthFt)} ft`);

    // Reset for next trace
    linearPoints = [];
    clearOverlay();
    updateTakeoffSummary();

  } else if (linearModeType === 'average') {
    // Add this run to average runs
    averageRuns.push({ lengthFt });
    updateAvgRunsDisplay();
    
    // Reset points for next run
    linearPoints = [];
    clearOverlay();
  }
}

// ‚îÄ‚îÄ‚îÄ AVERAGE MODE FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function updateAvgRunsDisplay() {
  const listEl = document.getElementById('avg-runs-list');
  const summaryEl = document.getElementById('avg-summary');

  if (averageRuns.length === 0) {
    listEl.innerHTML = '<div style="color:#888; font-size:0.75rem; font-style:italic;">No runs traced yet</div>';
    summaryEl.innerHTML = 'Trace your first sample run...';
    return;
  }

  let html = '';
  averageRuns.forEach((run, idx) => {
    html += `<div class="avg-run-item">Run ${idx + 1}: ${Math.round(run.lengthFt)} ft</div>`;
  });
  listEl.innerHTML = html;

  const avgLength = averageRuns.reduce((sum, r) => sum + r.lengthFt, 0) / averageRuns.length;
  summaryEl.innerHTML = `${averageRuns.length} runs ¬∑ Avg: <strong>${Math.round(avgLength)} ft</strong>`;
}

function addAnotherRun() {
  if (linearPoints.length >= 2) {
    finishLinear(); // Save current run
  }
  // LinearMode stays true, just reset points
  linearPoints = [];
  clearOverlay();
  document.getElementById('average-instructions').style.display = 'block';
}

function finishAverage() {
  if (averageRuns.length === 0) {
    alert('Please trace at least one sample run first.');
    return;
  }

  // If there's a current path being drawn, save it first
  if (linearPoints.length >= 2) {
    const lengthFt = calculatePathLength();
    if (lengthFt) {
      averageRuns.push({ lengthFt });
    }
  }

  // Show config modal
  document.getElementById('avg-config-modal').classList.add('show');
  document.getElementById('average-instructions').style.display = 'none';
  
  // Auto-update preview when values change
  document.getElementById('avg-drop-count').addEventListener('input', updateAvgPreview);
  document.getElementById('avg-drop-length').addEventListener('input', updateAvgPreview);
  
  updateAvgPreview();
}

function updateAvgPreview() {
  const dropCount = parseInt(document.getElementById('avg-drop-count').value) || 0;
  const dropLength = parseFloat(document.getElementById('avg-drop-length').value) || 0;
  
  if (dropCount === 0) {
    document.getElementById('avg-calc-preview').innerHTML = 'Enter drop count to see calculation...';
    return;
  }

  const avgLength = averageRuns.reduce((sum, r) => sum + r.lengthFt, 0) / averageRuns.length;
  const horizontalTotal = avgLength * dropCount;
  const verticalTotal = dropLength * dropCount;
  const grandTotal = horizontalTotal + verticalTotal;

  document.getElementById('avg-calc-preview').innerHTML = `
    <strong>Calculation:</strong><br>
    Horizontal: ${Math.round(avgLength)} ft √ó ${dropCount} drops = ${Math.round(horizontalTotal)} ft<br>
    Vertical: ${dropLength} ft √ó ${dropCount} drops = ${Math.round(verticalTotal)} ft<br>
    <strong>TOTAL: ${Math.round(grandTotal)} ft</strong>
  `;
}

function cancelAverageConfig() {
  document.getElementById('avg-config-modal').classList.remove('show');
  // Go back to tracing mode
  document.getElementById('average-instructions').style.display = 'block';
}

function confirmAverageConfig() {
  const dropCount = parseInt(document.getElementById('avg-drop-count').value);
  const dropLength = parseFloat(document.getElementById('avg-drop-length').value) || 0;

  if (!dropCount || dropCount < 1) {
    alert('Please enter the total number of drops.');
    return;
  }

  const avgLength = averageRuns.reduce((sum, r) => sum + r.lengthFt, 0) / averageRuns.length;
  const horizontalTotal = avgLength * dropCount;
  const verticalTotal = dropLength * dropCount;
  const grandTotal = horizontalTotal + verticalTotal;

  // Save average takeoff
  if (!linears[currentPage]) linears[currentPage] = [];
  linears[currentPage].push({
    itemId: linearItemId,
    lengthFt: grandTotal,
    type: 'average',
    avgLength: avgLength,
    dropCount: dropCount,
    dropLength: dropLength,
    runsTraced: averageRuns.length
  });

  alert(`‚úÖ Average takeoff saved!\n\n${CATALOG_NAMES[linearItemId]}\n${averageRuns.length} sample runs averaged\n${dropCount} drops √ó ${Math.round(avgLength)} ft + ${dropLength} ft drop\nTOTAL: ${Math.round(grandTotal)} ft`);

  // Clean up
  document.getElementById('avg-config-modal').classList.remove('show');
  endLinear();
  updateTakeoffSummary();
}

// ‚îÄ‚îÄ‚îÄ SIDEBAR TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let sidebarVisible = true;

function toggleSidebar() {
  sidebarVisible = !sidebarVisible;
  const sidebar = document.getElementById('sidebar');
  
  if (sidebarVisible) {
    sidebar.classList.remove('hidden');
  } else {
    sidebar.classList.add('hidden');
  }
}
</script>
</body>
</html>
